class(selected$TotalRestrictedUnits) = "numeric"
class(selected$ZIP) = "numeric"
class(selected$AMI20) = "numeric"
class(selected$AMI30) = "numeric"
class(selected$AMI35) = "numeric"
class(selected$AMI40) = "numeric"
class(selected$AMI45) = "numeric"
class(selected$AMI50) = "numeric"
class(selected$AMI60) = "numeric"
class(selected$AMI65) = "numeric"
class(selected$AMI80) = "numeric"
class(selected$Bedroom_0) = "numeric"
class(selected$Bedroom_1) = "numeric"
class(selected$Bedroom_2) = "numeric"
class(selected$Bedroom_3) = "numeric"
class(selected$Bedroom_4) = "numeric"
class(selected$Bedroom_Unknown) = "numeric"
class(selected$BedCount) = "numeric"
class(selected$Senior) = "numeric"
class(selected$Homeless) = "numeric"
class(selected$Disabled) = "numeric"
# Create new clean IRHD file
IRHD_clean <- copy(IRHD)
# Update records as determined by the "selected" dataframe
shared_fields <- intersect(names(selected), names(IRHD_clean))                                     # fields in common
dupes <- IRHD_clean[duplicated(PropertyID), cbind(.SD[1], number=.N), by=PropertyID] %>%           # duplicates (to exclude)
pull(UniqueID)
blankfill <- IRHD_clean %>%                                                                        # create IRHD data that matches fields from selected
.[!is.na(PropertyID) & UniqueID %not_in% (dupes), (colnames(.) %in% shared_fields), with=FALSE]  # include only common records, no duplicate keys
selected %<>% rows_patch(blankfill, by="PropertyID", unmatched="ignore")                           # replace NA in `selected` with values from `IRHD_clean`
IRHD_clean %<>% .[selected, (shared_fields):=mget(paste0("i.", shared_fields)), on=.(PropertyID)]  # carry over all matching variables from selected
rm(dupes, blankfill, shared_fields, long_IRHD, long_WSHFC, wshfc_colClasses, WSHFC_cols, irhd_colClasses, long_compare) # Clean up
# Add in new properties identified in newWSHFC
newWSHFC$HOMEcity <- as.character(newWSHFC$HOMEcity)
newWSHFC$HOMEcounty <- as.character(newWSHFC$HOMEcounty)
newWSHFC$HOMEstate <- as.character(newWSHFC$HOMEstate)
IRHD_clean <- bind_rows(IRHD_clean, newWSHFC)
## 9) Join IRHD_clean table with cleaned data from King County -------------------------
IRHD_clean <- rbind(IRHD_clean, KC,fill=TRUE)
IRHD_clean %<>%
relocate(AMI120, .after = AMI100)
# Join nomatchIRHD to IRHD_clean (we have confirmed with Commerce that these were excluded in 2021 data pull - check these in 2022 vintage)
IRHD_clean <- rbind(IRHD_clean, nomatchIRHD,fill=TRUE)
# Create new UniqueID value for each new record
IRHD_clean$tempID <- str_sub(IRHD_clean$UniqueID, start= -4)
first <- as.numeric(max(na.omit(IRHD_clean$tempID)))+1
last <- first + sum(is.na(IRHD_clean$tempID))-1
IRHD_clean$UniqueID[IRHD_clean$UniqueID == "" | is.na(IRHD_clean$UniqueID)] <- paste0('SH_', first:last)
IRHD_clean <- subset(IRHD_clean, select = -c(tempID))
View(IRHD_clean)
library(openxlsx)
library(tidyr)
library(tidyverse)
library(stringr)
library(dplyr)
library(psrccensus)
library(magrittr)
library(ggplot2)
# assumptions
metro_area <- "Seattle, WA"
earliestdate <- "2012-06-01"
latestdate <- "2023-06-30"
smalltbl_earliestdate <- "2021-06-01"
smalltbl_latestdate <- "2023-06-30"
term <- 360                     # 30 year mortgage
downpayment <- 0.20             # JCHS report used 3.5% but I will use 20% given our market conditions
propertytax <- 0.01             # King County is 1%, Snohomish County is 0.89%
propertyins <- 0.0035           # same as JCHS
mortgageins <- 0.00             # set to 0 for 20% downpayment
maxdebttoincome <- 0.31         # same as JCHS
interest_url <- "https://www.freddiemac.com/pmms/docs/historicalweeklydata.xlsx"
ZORI_url <- "https://files.zillowstatic.com/research/public_csvs/zori/Metro_zori_sm_sa_month.csv?t=1691785225"
ZHVI_url <- "https://files.zillowstatic.com/research/public_csvs/zhvi/Metro_zhvi_uc_sfrcondo_tier_0.33_0.67_sm_sa_month.csv"
# ZORI: Zillow Observed Rent Index - All Homes + Multifamily, Smoothed, Seasonally-Adjusted
# ZHVI: Zillow Home Value Index - All Homes (SFR & Condo) Time series, Smoothed, Seasonally-Adjusted
# ---------------- INTEREST RATE DATA ----------------
# download interest rate data from FreddieMac site
int_raw = read.xlsx(interest_url, sheet=1)
# clean up table
int <- int_raw[-(1:4),]
int <- subset(int, select = c(X1, X2))
# clean up data
int$X1 <- convertToDate(int$X1)
int$X2 <- as.numeric(int$X2)
int <- int[!is.na(int$X2),]
int <- int %>%
rename("int_date" = "X1") %>%
rename("int_rate" = "X2")
# refine dates
int <- with(int, int[(int_date >= earliestdate & int_date <= latestdate), ])
int$month <- str_sub(int$int_date, 1, 7)
int <- int[!duplicated(int$month), ]
# ---------------- ZILLOW DATA ----------------
ZORI_raw = read.csv(ZORI_url)
ZHVI_raw = read.csv(ZHVI_url)
# Clean data
ZORI <- subset(ZORI_raw, ZORI_raw$RegionName == metro_area)
ZHVI <- subset(ZHVI_raw, ZHVI_raw$RegionName == metro_area)
colnames(ZORI)<-gsub("X","",colnames(ZORI))
colnames(ZHVI)<-gsub("X","",colnames(ZHVI))
ZORI_long <- ZORI %>% select(starts_with("20"))
ZORI_long %<>% pivot_longer(everything(), names_to = "date", values_to = "zori_rent")
ZORI_long$month <- str_sub(ZORI_long$date, 1, 7)
ZORI_long$month <- gsub("\\.", "-", ZORI_long$month)
ZORI_long  %<>% relocate(month, .before = date)
ZORI_long$date <- gsub("\\.", "-", ZORI_long$date)
ZHVI_long <- ZHVI %>% select(starts_with("20"))
ZHVI_long %<>% pivot_longer(everything(), names_to = "date", values_to = "zhvi_value")
ZHVI_long$month <- str_sub(ZHVI_long$date, 1, 7)
ZHVI_long$month <- gsub("\\.", "-", ZHVI_long$month)
ZHVI_long  %<>% relocate(month, .before = date)
ZHVI_long <- subset(ZHVI_long, select = -c(date))
zillow <- merge(ZHVI_long, ZORI_long, by= "month")
# ---------------- JOIN DATA & ANALYZE ----------------
# crunch monthly payment, required income
analysis <- zillow %>% left_join(int)
analysis <- na.omit(analysis)
analysis$date <- as.Date(analysis$date)
analysis$mthlyrate <- analysis$int_rate / 100 / 12
analysis$r <- (1 + analysis$mthlyrate) ^ term - 1
analysis$loan_amt = analysis$zhvi_value - (downpayment * analysis$zhvi_value)
analysis$propertytax_mnthlypymt = analysis$loan_amt * propertytax / 12
analysis$propertyins_mnthlypymt = analysis$loan_amt * propertyins / 12
analysis$mortgageins_mnthlypymt = analysis$loan_amt * mortgageins / 12
analysis$payment = analysis$loan_amt * analysis$mthlyrate * ((analysis$r + 1) / analysis$r) + (analysis$propertytax_mnthlypymt + analysis$propertyins_mnthlypymt + analysis$mortgageins_mnthlypymt)
analysis$reqincome = (analysis$payment / maxdebttoincome) * 12
# ---------------- SMALL TABLE FOR EXPORT ----------------
smalltbl <- with(analysis, analysis[(date >= smalltbl_earliestdate & date <= smalltbl_latestdate), ])
smalltbl <- subset(smalltbl, str_sub(smalltbl$date, -5,-4) == str_sub(smalltbl_earliestdate, -5,-4))
smalltbl <- subset(smalltbl, select = c(date, int_rate, zhvi_value, payment, reqincome))
smalltbl <- smalltbl %>% arrange(ymd(smalltbl$date))
# ---------------- GRAPHING ----------------
reqincome_vs_int_plot <- ggplot(analysis)  +
geom_bar(aes(x=date, y=int_rate*20000),stat="identity", fill="skyblue2",colour="#ffffff")+
geom_line(aes(x=date, y=reqincome),stat="identity",color="grey40", linewidth=1)+
labs(title= paste(metro_area, "MSA - Mortgage for Median Home"),
x="Year",y="Minimum Income Required ($)") +
scale_y_continuous(labels=function(x) format(x, big.mark = ",", scientific = FALSE),sec.axis=sec_axis(~.*0.00005,name="Interest Rate (%)")) +
scale_x_date(breaks = scales::breaks_width("1 year"),minor_breaks = scales::breaks_width("1 year")) +
theme(text = element_text(size = 20))
reqincome_vs_int_plot
mortgage_vs_rent_plot <- ggplot(analysis)  +
geom_line(aes(x=date, y=payment),stat="identity",color="grey40", size=1)+
geom_line(aes(x=date, y=zori_rent),stat="identity",color="skyblue2", size=1)+
labs(title= paste(metro_area, "MSA - Mortgage vs Median Rent"),
x="Year",y="Monthly Payment ($)") +
scale_y_continuous(labels=function(x) format(x, big.mark = ",", scientific = FALSE),expand = c(0, 0), limits = c(0, NA)) +
scale_x_date(breaks = scales::breaks_width("1 year"),minor_breaks = scales::breaks_width("1 year")) +
theme(text = element_text(size = 20))
mortgage_vs_rent_plot
# TITLE: Average Mortgage Payment
# GEOGRAPHIES: King, Snohomish, Pierce (limited by Zillow)
# DATA SOURCE: FreddieMac, Zillow
# DATE MODIFIED: 8.22.2023
# AUTHOR: Eric Clute
library(openxlsx)
library(tidyr)
library(tidyverse)
library(stringr)
library(dplyr)
library(psrccensus)
library(magrittr)
library(ggplot2)
# assumptions
metro_area <- "Bremerton, WA"
earliestdate <- "2012-06-01"
latestdate <- "2023-06-30"
smalltbl_earliestdate <- "2021-06-01"
smalltbl_latestdate <- "2023-06-30"
term <- 360                     # 30 year mortgage
downpayment <- 0.20             # JCHS report used 3.5% but I will use 20% given our market conditions
propertytax <- 0.01             # King County is 1%, Snohomish County is 0.89%
propertyins <- 0.0035           # same as JCHS
mortgageins <- 0.00             # set to 0 for 20% downpayment
maxdebttoincome <- 0.31         # same as JCHS
interest_url <- "https://www.freddiemac.com/pmms/docs/historicalweeklydata.xlsx"
ZORI_url <- "https://files.zillowstatic.com/research/public_csvs/zori/Metro_zori_sm_sa_month.csv?t=1691785225"
ZHVI_url <- "https://files.zillowstatic.com/research/public_csvs/zhvi/Metro_zhvi_uc_sfrcondo_tier_0.33_0.67_sm_sa_month.csv"
# ZORI: Zillow Observed Rent Index - All Homes + Multifamily, Smoothed, Seasonally-Adjusted
# ZHVI: Zillow Home Value Index - All Homes (SFR & Condo) Time series, Smoothed, Seasonally-Adjusted
# ---------------- INTEREST RATE DATA ----------------
# download interest rate data from FreddieMac site
int_raw = read.xlsx(interest_url, sheet=1)
# clean up table
int <- int_raw[-(1:4),]
int <- subset(int, select = c(X1, X2))
# clean up data
int$X1 <- convertToDate(int$X1)
int$X2 <- as.numeric(int$X2)
int <- int[!is.na(int$X2),]
int <- int %>%
rename("int_date" = "X1") %>%
rename("int_rate" = "X2")
# refine dates
int <- with(int, int[(int_date >= earliestdate & int_date <= latestdate), ])
int$month <- str_sub(int$int_date, 1, 7)
int <- int[!duplicated(int$month), ]
# ---------------- ZILLOW DATA ----------------
ZORI_raw = read.csv(ZORI_url)
ZHVI_raw = read.csv(ZHVI_url)
# Clean data
ZORI <- subset(ZORI_raw, ZORI_raw$RegionName == metro_area)
ZHVI <- subset(ZHVI_raw, ZHVI_raw$RegionName == metro_area)
colnames(ZORI)<-gsub("X","",colnames(ZORI))
colnames(ZHVI)<-gsub("X","",colnames(ZHVI))
ZORI_long <- ZORI %>% select(starts_with("20"))
ZORI_long %<>% pivot_longer(everything(), names_to = "date", values_to = "zori_rent")
ZORI_long$month <- str_sub(ZORI_long$date, 1, 7)
ZORI_long$month <- gsub("\\.", "-", ZORI_long$month)
ZORI_long  %<>% relocate(month, .before = date)
ZORI_long$date <- gsub("\\.", "-", ZORI_long$date)
ZHVI_long <- ZHVI %>% select(starts_with("20"))
ZHVI_long %<>% pivot_longer(everything(), names_to = "date", values_to = "zhvi_value")
ZHVI_long$month <- str_sub(ZHVI_long$date, 1, 7)
ZHVI_long$month <- gsub("\\.", "-", ZHVI_long$month)
ZHVI_long  %<>% relocate(month, .before = date)
ZHVI_long <- subset(ZHVI_long, select = -c(date))
zillow <- merge(ZHVI_long, ZORI_long, by= "month")
# ---------------- JOIN DATA & ANALYZE ----------------
# crunch monthly payment, required income
analysis <- zillow %>% left_join(int)
analysis <- na.omit(analysis)
analysis$date <- as.Date(analysis$date)
analysis$mthlyrate <- analysis$int_rate / 100 / 12
analysis$r <- (1 + analysis$mthlyrate) ^ term - 1
analysis$loan_amt = analysis$zhvi_value - (downpayment * analysis$zhvi_value)
analysis$propertytax_mnthlypymt = analysis$loan_amt * propertytax / 12
analysis$propertyins_mnthlypymt = analysis$loan_amt * propertyins / 12
analysis$mortgageins_mnthlypymt = analysis$loan_amt * mortgageins / 12
analysis$payment = analysis$loan_amt * analysis$mthlyrate * ((analysis$r + 1) / analysis$r) + (analysis$propertytax_mnthlypymt + analysis$propertyins_mnthlypymt + analysis$mortgageins_mnthlypymt)
analysis$reqincome = (analysis$payment / maxdebttoincome) * 12
# ---------------- SMALL TABLE FOR EXPORT ----------------
smalltbl <- with(analysis, analysis[(date >= smalltbl_earliestdate & date <= smalltbl_latestdate), ])
smalltbl <- subset(smalltbl, str_sub(smalltbl$date, -5,-4) == str_sub(smalltbl_earliestdate, -5,-4))
smalltbl <- subset(smalltbl, select = c(date, int_rate, zhvi_value, payment, reqincome))
smalltbl <- smalltbl %>% arrange(ymd(smalltbl$date))
# ---------------- GRAPHING ----------------
reqincome_vs_int_plot <- ggplot(analysis)  +
geom_bar(aes(x=date, y=int_rate*20000),stat="identity", fill="skyblue2",colour="#ffffff")+
geom_line(aes(x=date, y=reqincome),stat="identity",color="grey40", linewidth=1)+
labs(title= paste(metro_area, "MSA - Mortgage for Median Home"),
x="Year",y="Minimum Income Required ($)") +
scale_y_continuous(labels=function(x) format(x, big.mark = ",", scientific = FALSE),sec.axis=sec_axis(~.*0.00005,name="Interest Rate (%)")) +
scale_x_date(breaks = scales::breaks_width("1 year"),minor_breaks = scales::breaks_width("1 year")) +
theme(text = element_text(size = 20))
reqincome_vs_int_plot
mortgage_vs_rent_plot <- ggplot(analysis)  +
geom_line(aes(x=date, y=payment),stat="identity",color="grey40", size=1)+
geom_line(aes(x=date, y=zori_rent),stat="identity",color="skyblue2", size=1)+
labs(title= paste(metro_area, "MSA - Mortgage vs Median Rent"),
x="Year",y="Monthly Payment ($)") +
scale_y_continuous(labels=function(x) format(x, big.mark = ",", scientific = FALSE),expand = c(0, 0), limits = c(0, NA)) +
scale_x_date(breaks = scales::breaks_width("1 year"),minor_breaks = scales::breaks_width("1 year")) +
theme(text = element_text(size = 20))
mortgage_vs_rent_plot
# pymt_int_plot <- ggplot(analysis)  +
#   geom_bar(aes(x=date, y=payment),stat="identity", fill="skyblue2",colour="#ffffff")+
#   geom_line(aes(x=date, y=int_rate*1000),stat="identity",color="grey40", size=1)+
#   labs(title= paste(metro_area, " - Mortgage for Median Home"),
#        x="Year",y="Monthly Mortgage") +
#   scale_y_continuous(labels=function(x) format(x, big.mark = ",", scientific = FALSE),sec.axis=sec_axis(~.*0.001,name="Interest Rate (%)")) +
#   scale_x_date(breaks = scales::breaks_width("2 year")) +
#   theme(text = element_text(size = 20))
# pymt_int_plot
# reqincome_plot <- ggplot(analysis)  +
#   geom_line(aes(x=date, y=reqincome),stat="identity",color="grey40", size=1)+
#   labs(title= paste(metro_area, " - Mortgage for Median Home"),
#        x="Year",y="Minimum Income Required($)") +
#   scale_x_date(breaks = scales::breaks_width("2 year")) +
#   scale_y_continuous(limits = c(0,200000),labels=function(x) format(x, big.mark = ",", scientific = FALSE)) +
#   theme(text = element_text(size = 20))
# reqincome_plot
# TITLE: Average Mortgage Payment
# GEOGRAPHIES: King, Snohomish, Pierce (limited by Zillow)
# DATA SOURCE: FreddieMac, Zillow
# DATE MODIFIED: 8.22.2023
# AUTHOR: Eric Clute
library(openxlsx)
library(tidyr)
library(tidyverse)
library(stringr)
library(dplyr)
library(psrccensus)
library(magrittr)
library(ggplot2)
# assumptions
metro_area <- "Bremerton, WA"
earliestdate <- "2012-06-01"
latestdate <- "2023-06-30"
smalltbl_earliestdate <- "2021-06-01"
smalltbl_latestdate <- "2023-06-30"
term <- 360                     # 30 year mortgage
downpayment <- 0.20             # JCHS report used 3.5% but I will use 20% given our market conditions
propertytax <- 0.01             # King County is 1%, Snohomish County is 0.89%
propertyins <- 0.0035           # same as JCHS
mortgageins <- 0.00             # set to 0 for 20% downpayment
maxdebttoincome <- 0.31         # same as JCHS
interest_url <- "https://www.freddiemac.com/pmms/docs/historicalweeklydata.xlsx"
ZORI_url <- "https://files.zillowstatic.com/research/public_csvs/zori/Metro_zori_sm_sa_month.csv?t=1691785225"
ZHVI_url <- "https://files.zillowstatic.com/research/public_csvs/zhvi/Metro_zhvi_uc_sfrcondo_tier_0.33_0.67_sm_sa_month.csv"
# ZORI: Zillow Observed Rent Index - All Homes + Multifamily, Smoothed, Seasonally-Adjusted
# ZHVI: Zillow Home Value Index - All Homes (SFR & Condo) Time series, Smoothed, Seasonally-Adjusted
# ---------------- INTEREST RATE DATA ----------------
# download interest rate data from FreddieMac site
int_raw = read.xlsx(interest_url, sheet=1)
# clean up table
int <- int_raw[-(1:4),]
int <- subset(int, select = c(X1, X2))
# clean up data
int$X1 <- convertToDate(int$X1)
int$X2 <- as.numeric(int$X2)
int <- int[!is.na(int$X2),]
int <- int %>%
rename("int_date" = "X1") %>%
rename("int_rate" = "X2")
# refine dates
int <- with(int, int[(int_date >= earliestdate & int_date <= latestdate), ])
int$month <- str_sub(int$int_date, 1, 7)
int <- int[!duplicated(int$month), ]
# ---------------- ZILLOW DATA ----------------
ZORI_raw = read.csv(ZORI_url)
ZHVI_raw = read.csv(ZHVI_url)
# Clean data
ZORI <- subset(ZORI_raw, ZORI_raw$RegionName == metro_area)
ZHVI <- subset(ZHVI_raw, ZHVI_raw$RegionName == metro_area)
colnames(ZORI)<-gsub("X","",colnames(ZORI))
colnames(ZHVI)<-gsub("X","",colnames(ZHVI))
ZORI_long <- ZORI %>% select(starts_with("20"))
ZORI_long %<>% pivot_longer(everything(), names_to = "date", values_to = "zori_rent")
ZORI_long$month <- str_sub(ZORI_long$date, 1, 7)
ZORI_long$month <- gsub("\\.", "-", ZORI_long$month)
ZORI_long  %<>% relocate(month, .before = date)
ZORI_long$date <- gsub("\\.", "-", ZORI_long$date)
ZHVI_long <- ZHVI %>% select(starts_with("20"))
ZHVI_long %<>% pivot_longer(everything(), names_to = "date", values_to = "zhvi_value")
ZHVI_long$month <- str_sub(ZHVI_long$date, 1, 7)
ZHVI_long$month <- gsub("\\.", "-", ZHVI_long$month)
ZHVI_long  %<>% relocate(month, .before = date)
ZHVI_long <- subset(ZHVI_long, select = -c(date))
zillow <- merge(ZHVI_long, ZORI_long, by= "month")
# ---------------- JOIN DATA & ANALYZE ----------------
# crunch monthly payment, required income
analysis <- zillow %>% left_join(int)
analysis <- na.omit(analysis)
analysis$date <- as.Date(analysis$date)
analysis$mthlyrate <- analysis$int_rate / 100 / 12
analysis$r <- (1 + analysis$mthlyrate) ^ term - 1
analysis$loan_amt = analysis$zhvi_value - (downpayment * analysis$zhvi_value)
analysis$propertytax_mnthlypymt = analysis$loan_amt * propertytax / 12
analysis$propertyins_mnthlypymt = analysis$loan_amt * propertyins / 12
analysis$mortgageins_mnthlypymt = analysis$loan_amt * mortgageins / 12
analysis$payment = analysis$loan_amt * analysis$mthlyrate * ((analysis$r + 1) / analysis$r) + (analysis$propertytax_mnthlypymt + analysis$propertyins_mnthlypymt + analysis$mortgageins_mnthlypymt)
analysis$reqincome = (analysis$payment / maxdebttoincome) * 12
# ---------------- SMALL TABLE FOR EXPORT ----------------
smalltbl <- with(analysis, analysis[(date >= smalltbl_earliestdate & date <= smalltbl_latestdate), ])
smalltbl <- subset(smalltbl, str_sub(smalltbl$date, -5,-4) == str_sub(smalltbl_earliestdate, -5,-4))
smalltbl <- subset(smalltbl, select = c(date, int_rate, zhvi_value, payment, reqincome))
smalltbl <- smalltbl %>% arrange(ymd(smalltbl$date))
# ---------------- GRAPHING ----------------
reqincome_vs_int_plot <- ggplot(analysis)  +
geom_bar(aes(x=date, y=int_rate*20000),stat="identity", fill="skyblue2",colour="#ffffff")+
geom_line(aes(x=date, y=reqincome),stat="identity",color="grey40", linewidth=1)+
labs(title= paste(metro_area, "MSA - Mortgage for Median Home"),
x="Year",y="Minimum Income Required ($)") +
scale_y_continuous(labels=function(x) format(x, big.mark = ",", scientific = FALSE),sec.axis=sec_axis(~.*0.00005,name="Interest Rate (%)")) +
scale_x_date(breaks = scales::breaks_width("1 year"),minor_breaks = scales::breaks_width("1 year")) +
theme(text = element_text(size = 20))
reqincome_vs_int_plot
mortgage_vs_rent_plot <- ggplot(analysis)  +
geom_line(aes(x=date, y=payment),stat="identity",color="grey40", size=1)+
geom_line(aes(x=date, y=zori_rent),stat="identity",color="skyblue2", size=1)+
labs(title= paste(metro_area, "MSA - Mortgage vs Median Rent"),
x="Year",y="Monthly Payment ($)") +
scale_y_continuous(labels=function(x) format(x, big.mark = ",", scientific = FALSE),expand = c(0, 0), limits = c(0, NA)) +
scale_x_date(breaks = scales::breaks_width("1 year"),minor_breaks = scales::breaks_width("1 year")) +
theme(text = element_text(size = 20))
mortgage_vs_rent_plot
# pymt_int_plot <- ggplot(analysis)  +
#   geom_bar(aes(x=date, y=payment),stat="identity", fill="skyblue2",colour="#ffffff")+
#   geom_line(aes(x=date, y=int_rate*1000),stat="identity",color="grey40", size=1)+
#   labs(title= paste(metro_area, " - Mortgage for Median Home"),
#        x="Year",y="Monthly Mortgage") +
#   scale_y_continuous(labels=function(x) format(x, big.mark = ",", scientific = FALSE),sec.axis=sec_axis(~.*0.001,name="Interest Rate (%)")) +
#   scale_x_date(breaks = scales::breaks_width("2 year")) +
#   theme(text = element_text(size = 20))
# pymt_int_plot
# reqincome_plot <- ggplot(analysis)  +
#   geom_line(aes(x=date, y=reqincome),stat="identity",color="grey40", size=1)+
#   labs(title= paste(metro_area, " - Mortgage for Median Home"),
#        x="Year",y="Minimum Income Required($)") +
#   scale_x_date(breaks = scales::breaks_width("2 year")) +
#   scale_y_continuous(limits = c(0,200000),labels=function(x) format(x, big.mark = ",", scientific = FALSE)) +
#   theme(text = element_text(size = 20))
# reqincome_plot
library(openxlsx)
library(tidyr)
library(tidyverse)
library(stringr)
library(dplyr)
library(psrccensus)
library(magrittr)
library(ggplot2)
# assumptions
metro_area <- "Seattle, WA"
earliestdate <- "2012-06-01"
latestdate <- "2023-06-30"
smalltbl_earliestdate <- "2021-06-01"
smalltbl_latestdate <- "2023-06-30"
term <- 360                     # 30 year mortgage
downpayment <- 0.20             # JCHS report used 3.5% but I will use 20% given our market conditions
propertytax <- 0.01             # King County is 1%, Snohomish County is 0.89%
propertyins <- 0.0035           # same as JCHS
mortgageins <- 0.00             # set to 0 for 20% downpayment
maxdebttoincome <- 0.31         # same as JCHS
interest_url <- "https://www.freddiemac.com/pmms/docs/historicalweeklydata.xlsx"
ZORI_url <- "https://files.zillowstatic.com/research/public_csvs/zori/Metro_zori_sm_sa_month.csv?t=1691785225"
ZHVI_url <- "https://files.zillowstatic.com/research/public_csvs/zhvi/Metro_zhvi_uc_sfrcondo_tier_0.33_0.67_sm_sa_month.csv"
# ZORI: Zillow Observed Rent Index - All Homes + Multifamily, Smoothed, Seasonally-Adjusted
# ZHVI: Zillow Home Value Index - All Homes (SFR & Condo) Time series, Smoothed, Seasonally-Adjusted
# ---------------- INTEREST RATE DATA ----------------
# download interest rate data from FreddieMac site
int_raw = read.xlsx(interest_url, sheet=1)
# clean up table
int <- int_raw[-(1:4),]
int <- subset(int, select = c(X1, X2))
# clean up data
int$X1 <- convertToDate(int$X1)
int$X2 <- as.numeric(int$X2)
int <- int[!is.na(int$X2),]
int <- int %>%
rename("int_date" = "X1") %>%
rename("int_rate" = "X2")
# refine dates
int <- with(int, int[(int_date >= earliestdate & int_date <= latestdate), ])
int$month <- str_sub(int$int_date, 1, 7)
int <- int[!duplicated(int$month), ]
# ---------------- ZILLOW DATA ----------------
ZORI_raw = read.csv(ZORI_url)
ZHVI_raw = read.csv(ZHVI_url)
# Clean data
ZORI <- subset(ZORI_raw, ZORI_raw$RegionName == metro_area)
ZHVI <- subset(ZHVI_raw, ZHVI_raw$RegionName == metro_area)
colnames(ZORI)<-gsub("X","",colnames(ZORI))
colnames(ZHVI)<-gsub("X","",colnames(ZHVI))
ZORI_long <- ZORI %>% select(starts_with("20"))
ZORI_long %<>% pivot_longer(everything(), names_to = "date", values_to = "zori_rent")
ZORI_long$month <- str_sub(ZORI_long$date, 1, 7)
ZORI_long$month <- gsub("\\.", "-", ZORI_long$month)
ZORI_long  %<>% relocate(month, .before = date)
ZORI_long$date <- gsub("\\.", "-", ZORI_long$date)
ZHVI_long <- ZHVI %>% select(starts_with("20"))
ZHVI_long %<>% pivot_longer(everything(), names_to = "date", values_to = "zhvi_value")
ZHVI_long$month <- str_sub(ZHVI_long$date, 1, 7)
ZHVI_long$month <- gsub("\\.", "-", ZHVI_long$month)
ZHVI_long  %<>% relocate(month, .before = date)
ZHVI_long <- subset(ZHVI_long, select = -c(date))
zillow <- merge(ZHVI_long, ZORI_long, by= "month")
# ---------------- JOIN DATA & ANALYZE ----------------
# crunch monthly payment, required income
analysis <- zillow %>% left_join(int)
analysis <- na.omit(analysis)
analysis$date <- as.Date(analysis$date)
analysis$mthlyrate <- analysis$int_rate / 100 / 12
analysis$r <- (1 + analysis$mthlyrate) ^ term - 1
analysis$loan_amt = analysis$zhvi_value - (downpayment * analysis$zhvi_value)
analysis$propertytax_mnthlypymt = analysis$loan_amt * propertytax / 12
analysis$propertyins_mnthlypymt = analysis$loan_amt * propertyins / 12
analysis$mortgageins_mnthlypymt = analysis$loan_amt * mortgageins / 12
analysis$payment = analysis$loan_amt * analysis$mthlyrate * ((analysis$r + 1) / analysis$r) + (analysis$propertytax_mnthlypymt + analysis$propertyins_mnthlypymt + analysis$mortgageins_mnthlypymt)
analysis$reqincome = (analysis$payment / maxdebttoincome) * 12
# ---------------- SMALL TABLE FOR EXPORT ----------------
smalltbl <- with(analysis, analysis[(date >= smalltbl_earliestdate & date <= smalltbl_latestdate), ])
smalltbl <- subset(smalltbl, str_sub(smalltbl$date, -5,-4) == str_sub(smalltbl_earliestdate, -5,-4))
smalltbl <- subset(smalltbl, select = c(date, int_rate, zhvi_value, payment, reqincome))
smalltbl <- smalltbl %>% arrange(ymd(smalltbl$date))
# ---------------- GRAPHING ----------------
reqincome_vs_int_plot <- ggplot(analysis)  +
geom_bar(aes(x=date, y=int_rate*20000),stat="identity", fill="skyblue2",colour="#ffffff")+
geom_line(aes(x=date, y=reqincome),stat="identity",color="grey40", linewidth=1)+
labs(title= paste(metro_area, "MSA - Mortgage for Median Home"),
x="Year",y="Minimum Income Required ($)") +
scale_y_continuous(labels=function(x) format(x, big.mark = ",", scientific = FALSE),sec.axis=sec_axis(~.*0.00005,name="Interest Rate (%)")) +
scale_x_date(breaks = scales::breaks_width("1 year"),minor_breaks = scales::breaks_width("1 year")) +
theme(text = element_text(size = 20))
reqincome_vs_int_plot
mortgage_vs_rent_plot <- ggplot(analysis)  +
geom_line(aes(x=date, y=payment),stat="identity",color="grey40", size=1)+
geom_line(aes(x=date, y=zori_rent),stat="identity",color="skyblue2", size=1)+
labs(title= paste(metro_area, "MSA - Mortgage vs Median Rent"),
x="Year",y="Monthly Payment ($)") +
scale_y_continuous(labels=function(x) format(x, big.mark = ",", scientific = FALSE),expand = c(0, 0), limits = c(0, NA)) +
scale_x_date(breaks = scales::breaks_width("1 year"),minor_breaks = scales::breaks_width("1 year")) +
theme(text = element_text(size = 20))
mortgage_vs_rent_plot
# pymt_int_plot <- ggplot(analysis)  +
#   geom_bar(aes(x=date, y=payment),stat="identity", fill="skyblue2",colour="#ffffff")+
#   geom_line(aes(x=date, y=int_rate*1000),stat="identity",color="grey40", size=1)+
#   labs(title= paste(metro_area, " - Mortgage for Median Home"),
#        x="Year",y="Monthly Mortgage") +
#   scale_y_continuous(labels=function(x) format(x, big.mark = ",", scientific = FALSE),sec.axis=sec_axis(~.*0.001,name="Interest Rate (%)")) +
#   scale_x_date(breaks = scales::breaks_width("2 year")) +
#   theme(text = element_text(size = 20))
# pymt_int_plot
# reqincome_plot <- ggplot(analysis)  +
#   geom_line(aes(x=date, y=reqincome),stat="identity",color="grey40", size=1)+
#   labs(title= paste(metro_area, " - Mortgage for Median Home"),
#        x="Year",y="Minimum Income Required($)") +
#   scale_x_date(breaks = scales::breaks_width("2 year")) +
#   scale_y_continuous(limits = c(0,200000),labels=function(x) format(x, big.mark = ",", scientific = FALSE)) +
#   theme(text = element_text(size = 20))
# reqincome_plot
View(smalltbl)
